// Translations for setup page
const setupTranslations = {
  vi: {
    'setup.subtitle': 'ChÃ o má»«ng! HÃ£y thiáº¿t láº­p káº¿t ná»‘i AniList cá»§a báº¡n',
    'setup.instructions.title': 'CÃ¡ch láº¥y thÃ´ng tin xÃ¡c thá»±c AniList',
    'setup.step1.title': 'Truy cáº­p AniList Developer',
    'setup.step1.desc': 'VÃ o <a href="https://anilist.co/settings/developer" target="_blank" class="external-link">https://anilist.co/settings/developer</a> vÃ  Ä‘Äƒng nháº­p vÃ o tÃ i khoáº£n AniList cá»§a báº¡n',
    'setup.step2.title': 'Táº¡o á»¨ng dá»¥ng Má»›i',
    'setup.step2.desc': 'Nháº¥p "Create New Client" vÃ  Ä‘iá»n tÃªn á»©ng dá»¥ng (vÃ­ dá»¥: "My AniSync Extension")',
    'setup.step3.title': 'Äáº·t Redirect URL',
    'setup.step3.desc': 'Äáº·t redirect URL chÃ­nh xÃ¡c nhÆ° hiá»ƒn thá»‹ trong form bÃªn dÆ°á»›i (cÃ³ dáº¡ng <span class="highlight">https://[extension-id].chromiumapp.org/</span>)',
    'setup.step4.title': 'Sao chÃ©p ThÃ´ng tin',
    'setup.step4.desc': 'Sau khi táº¡o, sao chÃ©p Client ID vÃ  Client Secret cá»§a báº¡n vÃ o form bÃªn pháº£i',
    'setup.step5.title': 'LÆ°u & Tiáº¿p tá»¥c',
    'setup.step5.desc': 'Nháº¥p "LÆ°u Cáº¥u hÃ¬nh" Ä‘á»ƒ hoÃ n táº¥t thiáº¿t láº­p',
    'setup.form.title': 'Nháº­p ThÃ´ng tin Cá»§a Báº¡n',
    'setup.form.clientId': 'Client ID',
    'setup.form.clientIdHelp': 'TÃ¬m tháº¥y trong cÃ i Ä‘áº·t developer AniList cá»§a báº¡n',
    'setup.form.clientSecret': 'Client Secret',
    'setup.form.clientSecretHelp': 'Giá»¯ bÃ­ máº­t vÃ  khÃ´ng chia sáº» vá»›i ai',
    'setup.form.redirectUrl': 'Redirect URL',
    'setup.form.redirectUrlHelp': 'Pháº£i khá»›p chÃ­nh xÃ¡c trong cÃ i Ä‘áº·t á»©ng dá»¥ng AniList cá»§a báº¡n',
    'setup.form.manageDomains': 'Quáº£n lÃ½ tÃªn miá»n tÃ¹y chá»‰nh',
    'setup.form.manageDomainsHelp': 'Cáº¥u hÃ¬nh cÃ¡c tÃªn miá»n AnimeVietSub tÃ¹y chá»‰nh náº¿u extension khÃ´ng hoáº¡t Ä‘á»™ng tá»± Ä‘á»™ng',
    'setup.form.submit': 'LÆ°u Cáº¥u hÃ¬nh',
    'setup.error.validation': 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ táº¥t cáº£ cÃ¡c trÆ°á»ng',
    'setup.error.clientId': 'Client ID khÃ´ng há»£p lá»‡',
    'setup.error.clientSecret': 'Client Secret khÃ´ng há»£p lá»‡',
    'setup.error.redirectUrl': 'Redirect URL pháº£i khá»›p chÃ­nh xÃ¡c vá»›i URL cá»§a extension',
    'setup.error.save': 'Lá»—i khi lÆ°u cáº¥u hÃ¬nh. Vui lÃ²ng thá»­ láº¡i.',
    'setup.success': 'Cáº¥u hÃ¬nh Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...',
    'setup.saving': 'Äang lÆ°u cáº¥u hÃ¬nh...',
    'setup.darkMode': 'Cháº¿ Ä‘á»™ Tá»‘i',
    'setup.lightMode': 'Cháº¿ Ä‘á»™ SÃ¡ng'
  },
  en: {
    'setup.subtitle': 'Welcome! Let\'s set up your AniList connection',
    'setup.instructions.title': 'How to get your AniList credentials',
    'setup.step1.title': 'Visit AniList Developer',
    'setup.step1.desc': 'Go to <a href="https://anilist.co/settings/developer" target="_blank" class="external-link">https://anilist.co/settings/developer</a> and log in to your AniList account',
    'setup.step2.title': 'Create New App',
    'setup.step2.desc': 'Click "Create New Client" and fill in the app name (e.g., "My AniSync Extension")',
    'setup.step3.title': 'Set Redirect URL',
    'setup.step3.desc': 'Set the redirect URL exactly as shown in the form below (format: <span class="highlight">https://[extension-id].chromiumapp.org/</span>)',
    'setup.step4.title': 'Copy Credentials',
    'setup.step4.desc': 'After creating, copy your Client ID and Client Secret to the form on the right',
    'setup.step5.title': 'Save & Continue',
    'setup.step5.desc': 'Click "Save Configuration" to complete the setup',
    'setup.form.title': 'Enter Your Credentials',
    'setup.form.clientId': 'Client ID',
    'setup.form.clientIdHelp': 'Found in your AniList developer settings',
    'setup.form.clientSecret': 'Client Secret',
    'setup.form.clientSecretHelp': 'Keep this secret and don\'t share it',
    'setup.form.redirectUrl': 'Redirect URL',
    'setup.form.redirectUrlHelp': 'This must match exactly in your AniList app settings',
    'setup.form.manageDomains': 'Manage Custom Domains',
    'setup.form.manageDomainsHelp': 'Configure custom AnimeVietSub domains if extension doesn\'t work automatically',
    'setup.form.submit': 'Save Configuration',
    'setup.error.validation': 'Please fill in all required fields',
    'setup.error.clientId': 'Invalid Client ID format',
    'setup.error.clientSecret': 'Invalid Client Secret format',
    'setup.error.redirectUrl': 'Redirect URL must match exactly with the extension URL',
    'setup.error.save': 'Error saving configuration. Please try again.',
    'setup.success': 'Configuration saved successfully! Redirecting...',
    'setup.saving': 'Saving configuration...',
    'setup.darkMode': 'Dark Mode',
    'setup.lightMode': 'Light Mode'
  }
};

// Current language and theme
let currentLanguage = 'vi';
let currentTheme = 'light';
let extensionId = '';
let redirectUrl = '';

// Initialize extension info when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Get extension ID
    extensionId = chrome.runtime.id;
    console.log('Extension ID detected:', extensionId);
    
    // Get redirect URL from Chrome Identity API
    redirectUrl = chrome.identity.getRedirectURL();
    console.log('Redirect URL from chrome.identity:', redirectUrl);
    
    // Äáº£m báº£o redirectUrl cÃ³ format Ä‘Ãºng cho AniList OAuth
    if (!redirectUrl || !redirectUrl.includes('.chromiumapp.org')) {
      // Tá»± táº¡o redirect URL vá»›i format Ä‘Ãºng
      redirectUrl = `https://${extensionId}.chromiumapp.org/`;
      console.log('Using manual redirect URL:', redirectUrl);
    }
    
    // Validate redirect URL format
    const expectedPattern = new RegExp(`https://${extensionId}\\.chromiumapp\\.org/?`);
    if (!expectedPattern.test(redirectUrl)) {
      console.warn('âš ï¸ Redirect URL format may be incorrect:', redirectUrl);
      redirectUrl = `https://${extensionId}.chromiumapp.org/`;
      console.log('Corrected redirect URL:', redirectUrl);
    }
    
    // Set redirect URL in the form
    const redirectUrlInput = document.getElementById('redirectUrl');
    if (redirectUrlInput) {
      redirectUrlInput.value = redirectUrl;
    }
    
    // Load existing credentials if any
    loadExistingCredentials();
    
    // Auto-focus first input
    const clientIdInput = document.getElementById('clientId');
    if (clientIdInput) {
      clientIdInput.focus();
    }
  } catch (error) {
    console.error('Error getting extension info:', error);
    
    // Fallback method
    try {
      extensionId = chrome.runtime.id;
      redirectUrl = `https://${extensionId}.chromiumapp.org/`;
      
      console.log('Extension ID (fallback):', extensionId);
      console.log('Redirect URL (fallback):', redirectUrl);
      
      const redirectUrlInput = document.getElementById('redirectUrl');
      if (redirectUrlInput) {
        redirectUrlInput.value = redirectUrl;
      }
      
      // Load existing credentials if any
      loadExistingCredentials();
      
      // Auto-focus first input
      const clientIdInput = document.getElementById('clientId');
      if (clientIdInput) {
        clientIdInput.focus();
      }
    } catch (fallbackError) {
      console.error('Fallback also failed:', fallbackError);
      
      // Last resort: manual construction
      if (extensionId) {
        redirectUrl = `https://${extensionId}.chromiumapp.org/`;
        
        const redirectUrlInput = document.getElementById('redirectUrl');
        if (redirectUrlInput) {
          redirectUrlInput.value = redirectUrl;
        }
      }
    }
  }
});

// Load saved preferences
chrome.storage.local.get(['language', 'theme']).then(result => {
  if (result.language) {
    currentLanguage = result.language;
    document.getElementById('languageSelect').value = currentLanguage;
  }
  if (result.theme) {
    currentTheme = result.theme;
  }
  updateLanguage();
  updateTheme();
});

// Language selector
document.getElementById('languageSelect').addEventListener('change', (e) => {
  currentLanguage = e.target.value;
  chrome.storage.local.set({ language: currentLanguage });
  updateLanguage();
});

// Theme toggle button
document.getElementById('themeToggle').addEventListener('click', () => {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  chrome.storage.local.set({ theme: currentTheme });
  updateTheme();
});

// Manage domains button
document.getElementById('manageDomains').addEventListener('click', () => {
  chrome.tabs.create({ url: 'domains.html' });
});

// Load existing credentials function
async function loadExistingCredentials() {
  try {
    const result = await chrome.storage.local.get(['clientId', 'clientSecret']);
    
    if (result.clientId) {
      const clientIdInput = document.getElementById('clientId');
      if (clientIdInput) {
        clientIdInput.value = result.clientId;
      }
    }
    
    if (result.clientSecret) {
      const clientSecretInput = document.getElementById('clientSecret');
      if (clientSecretInput) {
        clientSecretInput.value = result.clientSecret;
      }
    }
    
    console.log('Loaded existing credentials:', !!result.clientId, !!result.clientSecret);
  } catch (error) {
    console.error('Error loading existing credentials:', error);
  }
}

// Update language function
function updateLanguage() {
  const translations = setupTranslations[currentLanguage];
  
  document.querySelectorAll('[data-translate]').forEach(element => {
    const key = element.getAttribute('data-translate');
    if (translations[key]) {
      element.innerHTML = translations[key];
    }
  });
}

// Update theme function
function updateTheme() {
  const body = document.body;
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  
  if (currentTheme === 'dark') {
    body.classList.add('dark-theme');
    themeIcon.textContent = 'â˜€ï¸';
    themeText.textContent = setupTranslations[currentLanguage]['setup.lightMode'];
    themeText.setAttribute('data-translate', 'setup.lightMode');
  } else {
    body.classList.remove('dark-theme');
    themeIcon.textContent = 'ğŸŒ™';
    themeText.textContent = setupTranslations[currentLanguage]['setup.darkMode'];
    themeText.setAttribute('data-translate', 'setup.darkMode');
  }
}

// Form validation
function validateForm(formData) {
  const errors = [];
  
  // Check if all fields are filled
  if (!formData.clientId.trim() || !formData.clientSecret.trim() || !formData.redirectUrl.trim()) {
    errors.push(setupTranslations[currentLanguage]['setup.error.validation']);
    return errors;
  }
  
  // Validate Client ID (should be numeric)
  if (!/^\d+$/.test(formData.clientId.trim())) {
    errors.push(setupTranslations[currentLanguage]['setup.error.clientId']);
  }
  
  // Validate Client Secret (should be alphanumeric, length > 10)
  if (formData.clientSecret.trim().length < 10) {
    errors.push(setupTranslations[currentLanguage]['setup.error.clientSecret']);
  }
  
  // Validate Redirect URL
  if (formData.redirectUrl.trim() !== redirectUrl) {
    errors.push(setupTranslations[currentLanguage]['setup.error.redirectUrl']);
  }
  
  return errors;
}

// Show message function
function showMessage(message, isError = false) {
  const messageDiv = document.getElementById('message');
  messageDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
}

// Clear message function
function clearMessage() {
  document.getElementById('message').innerHTML = '';
}

// Form submission handler
document.getElementById('setupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMessage();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  
  // Get form data
  const formData = {
    clientId: document.getElementById('clientId').value,
    clientSecret: document.getElementById('clientSecret').value,
    redirectUrl: document.getElementById('redirectUrl').value
  };
  
  // Validate form
  const validationErrors = validateForm(formData);
  if (validationErrors.length > 0) {
    showMessage(validationErrors.join('<br>'), true);
    return;
  }
  
  // Disable submit button and show loading
  submitBtn.disabled = true;
  submitBtn.textContent = setupTranslations[currentLanguage]['setup.saving'];
  
  try {
    // Save configuration to Chrome storage
    const dataToSave = {
      clientId: formData.clientId.trim(),
      clientSecret: formData.clientSecret.trim(),
      setupCompleted: true
    };
    
    console.log('Saving setup data:', { 
      clientId: dataToSave.clientId ? 'exists' : 'missing',
      clientSecret: dataToSave.clientSecret ? 'exists' : 'missing',
      setupCompleted: dataToSave.setupCompleted 
    });
    
    await chrome.storage.local.set(dataToSave);
    
    // Verify save was successful
    const verification = await chrome.storage.local.get(['clientId', 'clientSecret', 'setupCompleted']);
    console.log('Setup verification:', verification);
    
    // Show success message
    showMessage(setupTranslations[currentLanguage]['setup.success']);
    
    // Redirect to popup after 2 seconds
    setTimeout(() => {
      window.close();
    }, 2000);
    
  } catch (error) {
    console.error('Error saving configuration:', error);
    showMessage(setupTranslations[currentLanguage]['setup.error.save'], true);
    
    // Re-enable submit button
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
});


